generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgcrypto, uuidOssp(map: "uuid-ossp")]
}

// ============================================================================
// FOUNDATION: Auth + Tenant + RBAC + Consent + AIActionLog
// ============================================================================

// --- Users & Authentication ---

model User {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email           String   @unique
  emailVerified   Boolean  @default(false)
  passwordHash    String?
  name            String?
  avatarUrl       String?
  isPlatformAdmin Boolean  @default(false) @map("is_platform_admin")
  status          String   @default("active") // active, disabled, pending
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  memberships       TenantMembership[]
  sessions          Session[]
  ownedTenants      Tenant[]             @relation("TenantOwner")
  sentInvitations   TenantInvitation[]   @relation("InvitationSender")
  consentsActed     Consent[]            @relation("ConsentActor")
  aiActionsPerformed AIActionLog[]       @relation("AIActionActor")
  aiDecisionsMade   AIActionDecision[]   @relation("DecisionMaker")

  @@index([email])
  @@index([isPlatformAdmin])
  @@map("users")
}

model Session {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String    @map("user_id") @db.Uuid
  activeTenantId String?   @map("active_tenant_id") @db.Uuid
  token          String    @unique
  userAgent      String?   @map("user_agent")
  ipAddress      String?   @map("ip_address")
  expiresAt      DateTime  @map("expires_at")
  revokedAt      DateTime? @map("revoked_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  user         User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  activeTenant Tenant? @relation(fields: [activeTenantId], references: [id])

  @@index([userId])
  @@index([activeTenantId])
  @@index([expiresAt])
  @@map("sessions")
}

// --- Tenants (Organizations) ---

model Tenant {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  slug        String   @unique
  plan        String   @default("free") // free, starter, pro, enterprise
  ownerUserId String   @map("owner_user_id") @db.Uuid
  settings    Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  owner       User               @relation("TenantOwner", fields: [ownerUserId], references: [id])
  memberships TenantMembership[]
  roles       Role[]
  invitations TenantInvitation[]
  consents    Consent[]
  aiActions   AIActionLog[]
  sessions    Session[]
  outboxEvents OutboxEvent[]
  idempotencyKeys IdempotencyKey[]

  // Module entities (scoped to tenant)
  tasks      Task[]
  dailyPlans DailyPlan[]

  @@index([slug])
  @@index([ownerUserId])
  @@map("tenants")
}

model TenantMembership {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  status    String   @default("active") // active, invited, disabled
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant            Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user              User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  roles             MembershipRole[]
  permissionOverrides PermissionOverride[]

  @@unique([tenantId, userId])
  @@index([userId])
  @@index([tenantId])
  @@map("tenant_memberships")
}

model TenantInvitation {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String    @map("tenant_id") @db.Uuid
  email       String
  token       String    @unique
  roleIds     String[]  @map("role_ids") @db.Uuid
  invitedById String    @map("invited_by_id") @db.Uuid
  expiresAt   DateTime  @map("expires_at")
  acceptedAt  DateTime? @map("accepted_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  tenant    Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invitedBy User   @relation("InvitationSender", fields: [invitedById], references: [id])

  @@index([tenantId])
  @@index([email])
  @@index([token])
  @@map("tenant_invitations")
}

// --- RBAC (Roles & Permissions) ---

model Role {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String?  @map("tenant_id") @db.Uuid // null = system role
  key         String   // owner, admin, sales, field_tech, client
  name        String
  description String?
  isSystem    Boolean  @default(false) @map("is_system")
  createdAt   DateTime @default(now()) @map("created_at")

  tenant           Tenant?          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  rolePermissions  RolePermission[]
  membershipRoles  MembershipRole[]

  @@unique([tenantId, key])
  @@index([isSystem, key])
  @@map("roles")
}

model Permission {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  key         String   @unique // e.g., ai.actions.create, users.invite
  name        String
  description String?
  category    String?  // ai, users, projects, tenants, etc.
  createdAt   DateTime @default(now()) @map("created_at")

  rolePermissions     RolePermission[]
  permissionOverrides PermissionOverride[]

  @@index([category])
  @@map("permissions")
}

model RolePermission {
  roleId       String @map("role_id") @db.Uuid
  permissionId String @map("permission_id") @db.Uuid

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([permissionId])
  @@map("role_permissions")
}

model MembershipRole {
  membershipId String @map("membership_id") @db.Uuid
  roleId       String @map("role_id") @db.Uuid
  assignedAt   DateTime @default(now()) @map("assigned_at")

  membership TenantMembership @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  role       Role             @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([membershipId, roleId])
  @@map("membership_roles")
}

model PermissionOverride {
  id           String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  membershipId String  @map("membership_id") @db.Uuid
  permissionId String  @map("permission_id") @db.Uuid
  granted      Boolean @default(true) // true = grant, false = deny

  membership TenantMembership @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  permission Permission       @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([membershipId, permissionId])
  @@map("permission_overrides")
}

// --- Consent Management ---

model Consent {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String    @map("tenant_id") @db.Uuid
  subjectType String    @map("subject_type") // user, customer, lead
  subjectId   String    @map("subject_id") @db.Uuid
  purposeKey  String    @map("purpose_key") // ai_assistance, recording, email, sms
  channel     String?   // web, mobile, verbal, written
  policyHash  String    @map("policy_hash")
  textVersion String    @map("text_version")
  language    String    @default("en")
  actorUserId String?   @map("actor_user_id") @db.Uuid
  evidence    Json?     // { ip, userAgent, mediaUrl, signatureUrl }
  capturedAt  DateTime  @default(now()) @map("captured_at")
  revokedAt   DateTime? @map("revoked_at")
  revokedBy   String?   @map("revoked_by") @db.Uuid

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  actor  User?  @relation("ConsentActor", fields: [actorUserId], references: [id])

  @@index([tenantId, subjectType, subjectId, purposeKey, capturedAt(sort: Desc)])
  @@map("consents")
}

// --- AIActionLog (Immutable Audit) ---

model AIActionLog {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId           String   @map("tenant_id") @db.Uuid
  actorUserId        String?  @map("actor_user_id") @db.Uuid
  actorService       String?  @map("actor_service") // system service name if not user
  
  // AI Request Details
  model              String   // gpt-4o, whisper-1, etc.
  promptHash         String   @map("prompt_hash")
  inputRefTable      String?  @map("input_ref_table") // e.g., leads, tasks
  inputRefId         String?  @map("input_ref_id") @db.Uuid
  inputSnapshot      Json     @map("input_snapshot") // redacted input
  
  // AI Response
  outputKind         String   @map("output_kind") // text, json, transcription, embedding
  outputSnapshot     Json     @map("output_snapshot") // full output
  citations          Json?    // [{ sourceId, type, snippet, confidence }]
  
  // Token & Cost
  tokenUsage         Json     @map("token_usage") // { prompt, completion, total }
  estimatedCostUsd   Decimal? @map("estimated_cost_usd") @db.Decimal(10, 6)
  
  // Review Workflow
  requiresReview     Boolean  @default(true) @map("requires_review")
  status             String   @default("proposed") // proposed, approved, rejected, executed
  
  // Side Effects
  plannedSideEffects Json?    @map("planned_side_effects") // [{ type, target, payload }]
  
  // PII & Redaction
  piiDetected        Boolean  @default(false) @map("pii_detected")
  redactionSummary   Json?    @map("redaction_summary")
  
  // Tracing
  traceId            String?  @map("trace_id")
  correlationId      String?  @map("correlation_id")
  contentHash        String?  @map("content_hash")
  
  // Timestamps
  latencyMs          Int?     @map("latency_ms")
  createdAt          DateTime @default(now()) @map("created_at")

  // Relations
  tenant    Tenant              @relation(fields: [tenantId], references: [id])
  actor     User?               @relation("AIActionActor", fields: [actorUserId], references: [id])
  decisions AIActionDecision[]
  sideEffects AIActionSideEffect[]

  @@index([tenantId, createdAt(sort: Desc)])
  @@index([tenantId, requiresReview, createdAt(sort: Desc)])
  @@index([tenantId, inputRefTable, inputRefId])
  @@index([promptHash])
  @@index([status])
  @@map("ai_action_log")
}

model AIActionDecision {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  logId          String   @map("log_id") @db.Uuid
  reviewerUserId String   @map("reviewer_user_id") @db.Uuid
  decision       String   // approve, reject
  reason         String?
  createdAt      DateTime @default(now()) @map("created_at")

  log      AIActionLog @relation(fields: [logId], references: [id])
  reviewer User        @relation("DecisionMaker", fields: [reviewerUserId], references: [id])

  @@index([logId, createdAt(sort: Desc)])
  @@map("ai_action_decisions")
}

model AIActionSideEffect {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  logId        String    @map("log_id") @db.Uuid
  tenantId     String    @map("tenant_id") @db.Uuid
  effectType   String    @map("effect_type") // email, sms, webhook, record_create, etc.
  targetRef    String?   @map("target_ref")
  payload      Json
  status       String    @default("pending") // pending, executing, completed, failed
  error        String?
  executedAt   DateTime? @map("executed_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  log AIActionLog @relation(fields: [logId], references: [id])

  @@index([logId])
  @@index([tenantId, status, createdAt(sort: Desc)])
  @@map("ai_action_side_effects")
}

// ============================================================================
// IDEMPOTENCY
// ============================================================================

model IdempotencyKey {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  keyHash     String   @map("key_hash") // SHA256 hash of tenantId + route + idempotencyKey
  route       String   // e.g., POST /taskflow/tasks
  method      String   // GET, POST, PATCH, etc.
  statusCode  Int      @map("status_code")
  responseBody Json    @map("response_body")
  expiresAt   DateTime @map("expires_at") // 24 hours from creation
  createdAt   DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, keyHash])
  @@index([expiresAt])
  @@index([tenantId, route])
  @@map("idempotency_keys")
}

// ============================================================================
// EVENT BUS: Outbox Pattern
// ============================================================================

model OutboxEvent {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId     String    @map("tenant_id") @db.Uuid
  eventType    String    @map("event_type") // e.g., ai.action.logged.v1
  aggregateId  String?   @map("aggregate_id") @db.Uuid
  payload      Json
  dedupeKey    String?   @unique @map("dedupe_key")
  status       String    @default("pending") // pending, published, failed
  attempts     Int       @default(0)
  lastError    String?   @map("last_error")
  occurredAt   DateTime  @default(now()) @map("occurred_at")
  publishedAt  DateTime? @map("published_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([status, createdAt])
  @@index([tenantId, aggregateId])
  @@map("outbox_events")
}

// ============================================================================
// MODULE: TaskFlow-Pro
// ============================================================================

model Task {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  projectId   String?  @map("project_id") @db.Uuid
  parentTaskId String? @map("parent_task_id") @db.Uuid // For checklist items

  source      String   // voice, photo, message, manual
  type        String   @default("general") // general, checklist_item, punch_item
  status      String   @default("open") // open, in_progress, completed, cancelled

  title       String
  description String   @default("")
  priority    String   @default("normal") // low, normal, high, urgent
  dueDate     DateTime? @map("due_date")

  // AI Metadata
  aiGenerated Boolean  @default(false) @map("ai_generated")
  aiActionLogId String? @map("ai_action_log_id") @db.Uuid
  
  createdById String?  @map("created_by_id") @db.Uuid
  assignedToId String? @map("assigned_to_id") @db.Uuid

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status, updatedAt])
  @@index([tenantId, projectId])
  @@index([tenantId, parentTaskId])
  @@map("tasks")
}

model DailyPlan {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  projectId   String?  @map("project_id") @db.Uuid
  date        String   // YYYY-MM-DD
  status      String   @default("pending_approval") // draft, pending_approval, approved, rejected

  taskIds     String[] @map("task_ids") @db.Uuid
  summary     String?
  
  // AI Metadata
  aiGenerated Boolean  @default(false) @map("ai_generated")
  aiActionLogId String? @map("ai_action_log_id") @db.Uuid

  createdById String?  @map("created_by_id") @db.Uuid
  approvedById String? @map("approved_by_id") @db.Uuid
  approvedAt  DateTime? @map("approved_at")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, date])
  @@index([tenantId, status])
  @@map("daily_plans")
}

// ============================================================================
// MODULE: MeetingFlow
// ============================================================================

model Meeting {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId     String    @map("tenant_id") @db.Uuid
  leadId       String?   @map("lead_id") @db.Uuid
  projectId    String?   @map("project_id") @db.Uuid
  
  title        String?
  scheduledAt  DateTime? @map("scheduled_at")
  startedAt    DateTime? @map("started_at")
  endedAt      DateTime? @map("ended_at")
  
  status       String    @default("scheduled") // scheduled, in_progress, completed, cancelled
  
  createdById  String    @map("created_by_id") @db.Uuid
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  participants   MeetingParticipant[]
  consents       MeetingConsent[]
  recordings     MeetingRecording[]
  transcripts    MeetingTranscript[]
  aiDrafts       MeetingAIDraft[]

  @@index([tenantId, status, createdAt(sort: Desc)])
  @@index([tenantId, leadId])
  @@map("meetings")
}

model MeetingParticipant {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  meetingId  String   @map("meeting_id") @db.Uuid
  userId     String?  @map("user_id") @db.Uuid // null for external participants
  
  name       String
  email      String?
  phone      String?
  role       String   // contractor, client, subcontractor, vendor
  
  createdAt  DateTime @default(now()) @map("created_at")

  meeting  Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  consents MeetingConsent[]

  @@index([meetingId])
  @@map("meeting_participants")
}

model MeetingConsent {
  id                     String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  meetingId              String   @map("meeting_id") @db.Uuid
  participantId          String   @map("participant_id") @db.Uuid
  
  consentStatementVersion String  @map("consent_statement_version")
  objectKey              String?  @map("object_key") // R2 audio proof
  
  geoLat                 Float?   @map("geo_lat")
  geoLng                 Float?   @map("geo_lng")
  geoAccuracyM           Float?   @map("geo_accuracy_m")
  
  capturedAt             DateTime @map("captured_at")
  capturedById           String   @map("captured_by_id") @db.Uuid
  
  createdAt              DateTime @default(now()) @map("created_at")

  meeting     Meeting            @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  participant MeetingParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@index([meetingId])
  @@index([participantId])
  @@map("meeting_consents")
}

model MeetingRecording {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  meetingId    String    @map("meeting_id") @db.Uuid
  tenantId     String    @map("tenant_id") @db.Uuid
  
  objectKey    String    @map("object_key") // R2 storage key
  contentType  String    @map("content_type")
  sizeBytes    BigInt    @map("size_bytes")
  sha256       String
  durationSec  Int?      @map("duration_sec")
  source       String    // mobile, web
  
  status       String    @default("uploaded") // uploaded, processing, ready, failed
  
  uploadedById String    @map("uploaded_by_id") @db.Uuid
  uploadedAt   DateTime  @default(now()) @map("uploaded_at")

  meeting     Meeting             @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  transcripts MeetingTranscript[]

  @@unique([objectKey, sha256])
  @@index([meetingId])
  @@index([tenantId, status])
  @@map("meeting_recordings")
}

model MeetingTranscript {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  meetingId    String    @map("meeting_id") @db.Uuid
  recordingId  String    @map("recording_id") @db.Uuid
  tenantId     String    @map("tenant_id") @db.Uuid
  
  status       String    @default("queued") // queued, processing, ready, failed
  language     String?
  durationSec  Int?      @map("duration_sec")
  
  textRaw      String?   @map("text_raw")
  textRedacted String?   @map("text_redacted")
  
  // AI metadata
  aiActionLogId String?  @map("ai_action_log_id") @db.Uuid
  
  error        String?
  
  startedAt    DateTime? @map("started_at")
  completedAt  DateTime? @map("completed_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  meeting   Meeting                   @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  recording MeetingRecording          @relation(fields: [recordingId], references: [id], onDelete: Cascade)
  segments  MeetingTranscriptSegment[]
  aiDrafts  MeetingAIDraft[]

  @@index([meetingId])
  @@index([recordingId])
  @@index([tenantId, status])
  @@map("meeting_transcripts")
}

model MeetingTranscriptSegment {
  id           String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  transcriptId String  @map("transcript_id") @db.Uuid
  
  startSec     Float   @map("start_sec")
  endSec       Float   @map("end_sec")
  
  textRaw      String  @map("text_raw")
  textRedacted String  @map("text_redacted")
  
  speakerId    String? @map("speaker_id")
  confidence   Float?

  transcript MeetingTranscript @relation(fields: [transcriptId], references: [id], onDelete: Cascade)

  @@index([transcriptId, startSec])
  @@map("meeting_transcript_segments")
}

model MeetingAIDraft {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  meetingId     String   @map("meeting_id") @db.Uuid
  transcriptId  String   @map("transcript_id") @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  
  status        String   @default("generating") // generating, pending_review, approved, rejected
  
  summaryText   String?  @map("summary_text")
  citations     Json?    // [{ segmentId, startSec, endSec }]
  
  actionItems   Json?    @map("action_items") // [{ title, details, dueDate, assigneeRole }]
  
  // AI metadata
  aiActionLogId String?  @map("ai_action_log_id") @db.Uuid
  ragContextIds String[] @map("rag_context_ids") @db.Uuid
  
  // Review
  reviewerId    String?  @map("reviewer_id") @db.Uuid
  reviewReason  String?  @map("review_reason")
  reviewedAt    DateTime? @map("reviewed_at")
  
  // Edits
  editedSummary String?  @map("edited_summary")
  editedActionItems Json? @map("edited_action_items")
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  meeting    Meeting           @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  transcript MeetingTranscript @relation(fields: [transcriptId], references: [id], onDelete: Cascade)

  @@index([meetingId])
  @@index([transcriptId])
  @@index([tenantId, status])
  @@map("meeting_ai_drafts")
}
